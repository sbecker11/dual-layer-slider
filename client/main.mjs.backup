import { ScrollingContentDiv } from './scrolling-content-div.mjs';

document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('DOMContentLoaded fired');
        // Use the current port from window.location
        const port = window.location.port || '3000';
        const baseUrl = `http://localhost:${port}`;
        
        console.log('Base URL:', baseUrl);
        const htmlContentUrl = `${baseUrl}/content/campaign_squares.html`;
        const backgroundImageUrls = [
            `${baseUrl}/backgrounds/sequoia-sunrise-470.png`,
            `${baseUrl}/backgrounds/milky-way-blue-470.jpeg`
        ];
        
        console.log('Loading content from:', htmlContentUrl);
        
        // Override CSS variable and html/body background from external stylesheet
        // Inject a style element into the head with highest priority
        const overrideStyle = document.createElement('style');
        overrideStyle.textContent = ':root { --bg-color: #ffffff !important; } html, body { background-color: #ffffff !important; }';
        document.head.appendChild(overrideStyle);
        
        // Also set inline styles as backup
        document.documentElement.style.setProperty('--bg-color', '#ffffff');
        document.body.style.backgroundColor = '#ffffff';
        document.documentElement.style.backgroundColor = '#ffffff';
        
        const contentDiv = await ScrollingContentDiv.create( htmlContentUrl, backgroundImageUrls );
        console.log('ScrollingContentDiv created successfully');
        
        // Inject campaign slideshow JavaScript after content loads
        // Scripts in innerHTML don't execute, so we run them here
        // Use string concatenation to avoid template literal issues in heredoc
        setTimeout(() => {
            const script = document.createElement('script');
            const scriptCode = [
                '// Campaign slideshow functionality',
                'const marks = {',
                '    keeps: new Set(),',
                '    deletes: new Set()',
                '};',
                '',
                'let totalImages = 0;',
                '',
                'function updateTotalImages() {',
                '    const htmlContentDiv = document.getElementById("html-content-div");',
                '    if (htmlContentDiv) {',
                '        totalImages = htmlContentDiv.querySelectorAll(".image-card").length;',
                '    }',
                '}',
                '',
                '// Load saved state',
                'function loadState() {',
                '    try {',
                '        const saved = localStorage.getItem("campaignSlideshowState");',
                '        if (saved) {',
                '            const state = JSON.parse(saved);',
                '            marks.keeps = new Set(state.keeps || []);',
                '            marks.deletes = new Set(state.deletes || []);',
                '            ',
                '            // Restore visual state',
                '            const htmlContentDiv = document.getElementById("html-content-div");',
                '            if (htmlContentDiv) {',
                '                state.keeps.forEach(path => {',
                '                    const card = htmlContentDiv.querySelector("[data-path=\\"" + path + "\\"] .image-card");',
                '                    if (card) {',
                '                        card.classList.add("marked-keep");',
                '                        const keepBtn = card.querySelector(".btn-keep");',
                '                        if (keepBtn) keepBtn.classList.add("active");',
                '                    }',
                '                });',
                '                ',
                '                state.deletes.forEach(path => {',
                '                    const card = htmlContentDiv.querySelector("[data-path=\\"" + path + "\\"] .image-card");',
                '                    if (card) {',
                '                        card.classList.add("marked-delete");',
                '                        const deleteBtn = card.querySelector(".btn-delete");',
                '                        if (deleteBtn) deleteBtn.classList.add("active");',
                '                    }',
                '                });',
                '            }',
                '        }',
                '    } catch (e) {',
                '        console.error("Error loading state:", e);',
                '    }',
                '    updateCounts();',
                '}',
                '',
                '// Save state',
                'function saveState() {',
                '    try {',
                '        const state = {',
                '            deletes: Array.from(marks.deletes)',
                '        };',
                '        localStorage.setItem("campaignSlideshowState", JSON.stringify(state));',
                '    } catch (e) {',
                '        console.error("Error saving state:", e);',
                '    }',
                '}',
                '',
                '// Update counts',
                'function updateCounts() {',
                '    const htmlContentDiv = document.getElementById("html-content-div");',
                '    if (!htmlContentDiv) return;',
                '    ',
                '    const deleteCount = htmlContentDiv.querySelector("#deleteCount");',
                '    const remainingCount = htmlContentDiv.querySelector("#remainingCount");',
                '    ',
                '    if (deleteCount) deleteCount.textContent = marks.deletes.size;',
                '    if (remainingCount) {',
                '        const remaining = totalImages - marks.deletes.size;',
                '        remainingCount.textContent = remaining;',
                '    }',
                '}',
                '',
                '// Marking functions',
                '// Keep functionality removed - only delete button remains',
                'window.markKeep = function(index, path) {',
                '    // Keep functionality removed - this function does nothing',
                '    return;',
                '};',
                '',
                'window.markDelete = function(index, path) {',
                '    console.log("markDelete called", index, path);',
                '    const htmlContentDiv = document.getElementById("html-content-div");',
                '    if (!htmlContentDiv) return;',
                '    ',
                '    const card = htmlContentDiv.querySelector("#card-" + index);',
                '    if (!card) {',
                '        console.error("Card not found:", "card-" + index);',
                '        return;',
                '    }',
                '    const deleteBtn = card.querySelector(".btn-delete");',
                '    ',
                '    if (marks.deletes.has(path)) {',
                '        marks.deletes.delete(path);',
                '        card.classList.remove("marked-delete");',
                '        if (deleteBtn) {',
                '            deleteBtn.classList.remove("active");',
                '            deleteBtn.textContent = "ðŸ—‘ï¸ Delete";',
                '        }',
                '    } else {',
                '        marks.deletes.add(path);',
                '        card.classList.add("marked-delete");',
                '        if (deleteBtn) {',
                '            deleteBtn.classList.add("active");',
                '            deleteBtn.textContent = "âŒ Delete";',
                '        }',
                '    }',
                '    ',
                '    updateCounts();',
                '    saveState();',
                '};',
                '',
                '// Export results',
                'window.exportResults = function() {',
                '    const htmlContentDiv = document.getElementById("html-content-div");',
                '    if (!htmlContentDiv) return;',
                '    ',
                '    const results = {',
                '        timestamp: new Date().toISOString(),',
                '        total: totalImages,',
                '        keeps: Array.from(marks.keeps).map(path => {',
                '            const item = htmlContentDiv.querySelector("[data-path=\\"" + path + "\\"]");',
                '            return {',
                '                path: path,',
                '                timestamp: item ? item.dataset.timestamp : "",',
                '                product: item ? item.dataset.product : "",',
                '                campaign: item ? item.dataset.campaign : ""',
                '            };',
                '        }),',
                '        deletes: Array.from(marks.deletes).map(path => {',
                '            const item = htmlContentDiv.querySelector("[data-path=\\"" + path + "\\"]");',
                '            return {',
                '                path: path,',
                '                timestamp: item ? item.dataset.timestamp : "",',
                '                product: item ? item.dataset.product : "",',
                '                campaign: item ? item.dataset.campaign : ""',
                '            };',
                '        })',
                '    };',
                '    ',
                '    const blob = new Blob([JSON.stringify(results, null, 2)], { type: "application/json" });',
                '    const url = URL.createObjectURL(blob);',
                '    const a = document.createElement("a");',
                '    a.href = url;',
                '    const dateStr = new Date().toISOString().split("T")[0];',
                '    a.download = "campaign_slideshow_results_" + dateStr + ".json";',
                '    document.body.appendChild(a);',
                '    a.click();',
                '    document.body.removeChild(a);',
                '    URL.revokeObjectURL(url);',
                '    ',
                '    alert("Exported " + results.keeps.length + " keeps and " + results.deletes.length + " deletes!");',
                '};',
                '',
                '// Set up event delegation for buttons',
                'function setupEventDelegation() {',
                '    const htmlContentDiv = document.getElementById("html-content-div");',
                '    if (htmlContentDiv) {',
                '        // Handle keep/delete buttons',
                '        htmlContentDiv.addEventListener("click", function(e) {',
                '            const btn = e.target.closest(".btn-keep, .btn-delete");',
                '            if (btn) {',
                '                e.preventDefault();',
                '                e.stopPropagation();',
                '                const action = btn.dataset.action;',
                '                const index = parseInt(btn.dataset.index);',
                '                const path = btn.dataset.path;',
                '                ',
                '                console.log("Button clicked:", action, index, path);',
                '                ',
                '                if (action === "keep") {',
                '                    window.markKeep(index, path);',
                '                } else if (action === "delete") {',
                '                    window.markDelete(index, path);',
                '                }',
                '                return false;',
                '            }',
                '            ',
                '            // Handle export button',
                '            if (e.target.id === "export-results-btn" || e.target.closest("#export-results-btn")) {',
                '                e.preventDefault();',
                '                e.stopPropagation();',
                '                window.exportResults();',
                '                return false;',
                '            }',
                '        }, true);',
                '    }',
                '}',
                '',
                '// Initialize after content loads',
                'setTimeout(() => {',
                '    updateTotalImages();',
                '    loadState();',
                '    setupEventDelegation();',
                '}, 1000);'
            ].join('\\n');
            script.textContent = scriptCode;
            document.body.appendChild(script);
        }, 1000);
    } catch (error) {
        console.error('Failed to initialize ScrollingContentDiv:', error);
        console.error('Error stack:', error.stack);
        // Show error on page
        document.body.innerHTML = '<div style="padding: 20px; font-family: monospace; background: #fee; border: 2px solid #f00; margin: 20px;"><h1>Error Loading Content</h1><p><strong>Error:</strong> ' + error.message + '</p><p><strong>Stack:</strong></p><pre>' + error.stack + '</pre><p>Check the browser console for more details.</p></div>';
    }
});
